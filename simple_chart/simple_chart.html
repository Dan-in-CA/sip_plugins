$def with(settings)

$var title: $_('SIP Simple Chart')
$var page: simple_chart
<script>
  // Initialize behaviors
  jQuery(document).ready(function(){
      jQuery("button#cConfig").click(function(){
          window.location="/simple_chart_config";
      });

      jQuery("button#cCancel").click(function(){
          window.location="/";
      });

      jQuery("button#docButton").click(function(){
          window.open("static/docs/plugins/simple_chart-docs.html", "_blank");
      });
  });

  function convertStrToInt(d) {
      var conv = {}
      for (const [key, value] of Object.entries(d)) {
          conv[key] = +value;
          if (isNaN(conv[key])) {
              conv[key] = value;
          }
      }
      return conv
  }

  function scrollChart(chart, direction) {
      const WEEK = (86400 * 7 * 1000);
      if (direction == "cur") {
          const cur = new Date();
          let day = cur.getDay();

          // adjust when day is Sunday
          let date_mon = cur.getDate() - day + (day == 0 ? -6 : 1);
          cur.setDate(date_mon);
          cur.setHours(0, 0, 0, 0);

          chart.options.scales.x.min = cur.getTime();
          chart.options.scales.x.max = cur.getTime() + WEEK

      } else if (direction == "prev") {
          chart.options.scales.x.max = chart.options.scales.x.min
          chart.options.scales.x.min = chart.options.scales.x.min - WEEK

      } else if (direction == "next") {
          chart.options.scales.x.min = chart.options.scales.x.max
          chart.options.scales.x.max = chart.options.scales.x.max + WEEK
      }

      chart.update();
  }
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/d3@7.8.5/dist/d3.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1/dist/chartjs-adapter-luxon.umd.min.js"></script>

<div id="plugin">
  <div class="title">Simple Chart
    <button class="execute" id="docButton" type="button" >$_('Help')</button>
  </div>
  $#{settings}


    $for chart in settings:
      $if "enabled" in settings[chart]:
        </br>
        </br>
        <div style="text-align: center">
          <button id="pPrev" onclick="scrollChart(chart_${loop.index}, 'prev');">&lt;&lt; Prev</button>
          <button id="pCur" onclick="scrollChart(chart_${loop.index}, 'cur');">Current</button>
          <button id="pNext" onclick="scrollChart(chart_${loop.index}, 'next');">Next &gt;&gt;</button>
        </div>
        <canvas id="chart_${loop.index}"></canvas>
        <script>
          var chart_${loop.index}
          var files = $:settings[chart]["data"]
          var promises_${loop.index} = []
          for (i in files) {
              promises_${loop.index}.push(d3.csv(files[i], function(d) {return convertStrToInt(d)}))
          }

          Promise.all(
              promises_${loop.index}
          ).then(function(csv_data){
              chart_${loop.index} = chart_${loop.index}(csv_data);
              scrollChart(chart_${loop.index}, 'cur')

          }).catch(function(err){
              console.log(err)
          })

          function chart_${loop.index}(csv_data) {
              var datasets = []
              for (i in files) {
                  // Remove extension and path
                  label = files[i].replace(/\.[^/.]+$$/, "");
                  label = label.split("/").pop()
                  datasets.push({ data: csv_data[i], label: label});
              }

              var chart = new Chart("chart_${loop.index}", {
                  type: "line",
                  data: {
                      datasets: datasets,
                  },
                  options: $:settings[chart]["options"],
              })
              return chart
          }
        </script>

  </br>
  <div class="controls">
    <button id="cConfig" class="execute">$_('Config')</button>
    <button id="cCancel" class="cancel danger">$_('Cancel')</button>
  </div>
</div>
